<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShieldAI | Reports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      .grid-bg {
        background-image: radial-gradient(circle at 1px 1px, rgba(167, 139, 250, 0.10) 1px, transparent 0);
        background-size: 22px 22px;
      }
      .glow {
        box-shadow: 0 0 0.75rem rgba(167, 139, 250, 0.14), 0 0 2rem rgba(34, 211, 238, 0.06);
      }
    </style>
  </head>
  <body class="min-h-screen bg-zinc-950 text-zinc-100">
    <div class="grid-bg min-h-screen">
      <header class="border-b border-violet-500/10 bg-zinc-950/70 backdrop-blur">
        <div class="mx-auto flex max-w-7xl flex-col gap-3 px-4 py-4 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex items-center gap-3">
            <a href="/" class="flex items-center gap-3">
              <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-violet-400/30 to-cyan-400/10 p-[1px] glow">
                <div class="flex h-full w-full items-center justify-center rounded-xl bg-zinc-950">
                  <svg viewBox="0 0 24 24" class="h-6 w-6 text-violet-300" fill="none" stroke="currentColor" stroke-width="1.6">
                    <path d="M4 4h16v16H4z" />
                    <path d="M7 15V9" />
                    <path d="M12 15V7" />
                    <path d="M17 15v-4" />
                  </svg>
                </div>
              </div>
              <div>
                <div class="text-lg font-semibold tracking-wide">Reports</div>
                <div class="text-xs text-zinc-400">Trends, distributions, and audit trails</div>
              </div>
            </a>
          </div>
          <div class="flex w-full flex-wrap items-center justify-end gap-2 sm:w-auto">
            <a href="/" class="inline-flex items-center gap-2 rounded-xl border border-zinc-800 bg-zinc-950/60 px-2.5 py-2 text-xs text-zinc-200 hover:bg-zinc-900 sm:px-3 sm:text-sm"
              ><span aria-hidden="true">üè†</span><span class="hidden sm:inline">Monitor</span></a
            >
            <a href="/scanner" class="inline-flex items-center gap-2 rounded-xl border border-emerald-400/20 bg-emerald-400/10 px-2.5 py-2 text-xs text-emerald-200 hover:bg-emerald-400/15 sm:px-3 sm:text-sm"
              ><span aria-hidden="true">üî¨</span><span class="hidden sm:inline">Analysis</span></a
            >
            <a href="/reports" class="inline-flex items-center gap-2 rounded-xl border border-violet-400/20 bg-violet-400/10 px-2.5 py-2 text-xs text-violet-200 hover:bg-violet-400/15 sm:px-3 sm:text-sm"
              ><span aria-hidden="true">üìä</span><span class="hidden sm:inline">Reports</span></a
            >
            <div id="authLinks" class="hidden items-center gap-2">
              <a href="/login" class="rounded-xl border border-zinc-800 bg-zinc-950/60 px-3 py-2 text-sm text-zinc-200 hover:bg-zinc-900">Login</a>
              <a href="/signup" class="rounded-xl border border-violet-400/20 bg-violet-400/10 px-3 py-2 text-sm text-violet-200 hover:bg-violet-400/15">Sign up</a>
            </div>
            <div id="userMenuWrap" class="relative hidden md:block">
              <button id="profileBtn" type="button" class="flex items-center gap-2 rounded-xl border border-zinc-800 bg-zinc-950/60 px-2.5 py-2 text-xs text-zinc-200 hover:bg-zinc-900 sm:px-3 sm:text-sm">
                <span id="profileAvatar" class="flex h-7 w-7 items-center justify-center rounded-lg border border-violet-400/20 bg-violet-400/10 text-xs font-semibold text-violet-200">U</span>
                <span id="profileEmail" class="hidden max-w-[180px] truncate text-sm text-zinc-200 sm:inline">Account</span>
                <svg viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4 text-zinc-400">
                  <path
                    fill-rule="evenodd"
                    d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.168l3.71-3.938a.75.75 0 1 1 1.08 1.04l-4.24 4.5a.75.75 0 0 1-1.08 0l-4.24-4.5a.75.75 0 0 1 .02-1.06Z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <div id="profileMenu" class="hidden absolute right-0 mt-2 w-72 overflow-hidden rounded-2xl border border-zinc-800 bg-zinc-950/95 shadow-2xl backdrop-blur">
                <div class="px-4 py-3">
                  <div class="text-[11px] text-zinc-500">Signed in as</div>
                  <div id="profileEmailMenu" class="mt-1 truncate text-sm font-medium text-zinc-200">‚Äî</div>
                </div>
                <div class="border-t border-zinc-800/80 px-2 py-2">
                  <button id="btnLogout" class="w-full rounded-xl border border-red-400/20 bg-red-400/10 px-3 py-2 text-left text-sm text-red-200 hover:bg-red-400/15" type="button">
                    Log out
                  </button>
                </div>
              </div>
            </div>
            <button id="btnRefresh" class="rounded-xl border border-zinc-700 bg-zinc-900/60 px-3 py-2 text-sm text-zinc-200 hover:bg-zinc-900">Refresh</button>
          </div>
        </div>
      </header>

      <main class="mx-auto max-w-7xl px-4 py-6">
        <section class="grid gap-4 lg:grid-cols-3">
          <div class="glow rounded-2xl border border-zinc-800 bg-zinc-950/60 p-4">
            <div class="text-xs text-zinc-400">Total Scans</div>
            <div class="mt-1 text-3xl font-semibold tabular-nums" id="totalScans">0</div>
          </div>
          <div class="glow rounded-2xl border border-zinc-800 bg-zinc-950/60 p-4">
            <div class="text-xs text-zinc-400">Blocked</div>
            <div class="mt-1 text-3xl font-semibold tabular-nums" id="blocked">0</div>
          </div>
          <div class="glow rounded-2xl border border-zinc-800 bg-zinc-950/60 p-4">
            <div class="text-xs text-zinc-400">Detection Accuracy (feedback)</div>
            <div class="mt-1 text-3xl font-semibold tabular-nums" id="accuracy">‚Äî</div>
            <div class="mt-1 text-xs text-zinc-500" id="accuracyMeta">No feedback yet.</div>
          </div>
        </section>

        <section class="mt-6 grid gap-4 lg:grid-cols-3">
          <div class="glow rounded-2xl border border-zinc-800 bg-zinc-950/60 p-4 lg:col-span-2">
            <h2 class="text-base font-semibold">Timeline</h2>
            <p class="mt-1 text-sm text-zinc-400">Daily scans and blocked attacks.</p>
            <canvas id="chartTimeline" class="mt-3"></canvas>
          </div>
          <div class="glow rounded-2xl border border-zinc-800 bg-zinc-950/60 p-4">
            <h2 class="text-base font-semibold">Attack Types</h2>
            <p class="mt-1 text-sm text-zinc-400">Distribution of blocked events.</p>
            <canvas id="chartTypes" class="mt-3"></canvas>
          </div>
        </section>

        <section class="mt-6 glow rounded-2xl border border-zinc-800 bg-zinc-950/60 p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-base font-semibold">Recent Blocked Threats</h2>
              <p class="mt-1 text-sm text-zinc-400">Audit feed from SQLite (blocked = true).</p>
            </div>
            <div class="text-xs text-zinc-500">Tip: run scans on the dashboard to populate.</div>
          </div>

          <div class="mt-4 overflow-auto rounded-xl border border-zinc-800">
            <table class="min-w-full text-left text-sm">
              <thead class="bg-zinc-950">
                <tr class="text-xs text-zinc-400">
                  <th class="px-3 py-2">Time (UTC)</th>
                  <th class="px-3 py-2">Type</th>
                  <th class="px-3 py-2">Confidence</th>
                  <th class="px-3 py-2">Verdict</th>
                  <th class="px-3 py-2">IP</th>
                </tr>
              </thead>
              <tbody id="tableBody" class="divide-y divide-zinc-800 bg-zinc-950/40"></tbody>
            </table>
          </div>
        </section>

        <footer class="mt-8 rounded-2xl border border-zinc-800 bg-zinc-950/60 px-4 py-3 text-xs text-zinc-500">
          ¬© <span id="footerYear"></span> ShieldAI. All rights reserved.
        </footer>
      </main>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const api = {
        stats: () => fetch("/api/stats").then((r) => r.json()),
        threats: (limit = 100) => fetch(`/api/threats?limit=${limit}`).then((r) => r.json()),
      };

      function setAuthedUI(email) {
        $("authLinks")?.classList.add("hidden");
        $("authLinks")?.classList.remove("flex");
        $("userMenuWrap")?.classList.remove("hidden");
        const em = String(email || "Account");
        $("profileEmail").textContent = em;
        $("profileEmailMenu").textContent = em;
        $("profileAvatar").textContent = (em[0] || "U").toUpperCase();
      }

      function setLoggedOutUI() {
        $("profileMenu")?.classList.add("hidden");
        $("userMenuWrap")?.classList.add("hidden");
        $("authLinks")?.classList.remove("hidden");
        $("authLinks")?.classList.add("flex");
      }

      async function initAuthUI() {
        try {
          const res = await fetch("/api/auth/me");
          if (!res.ok) throw new Error("unauthorized");
          const me = await res.json().catch(() => ({}));
          if (!me || !me.email) throw new Error("unauthorized");
          setAuthedUI(me.email);
        } catch {
          setLoggedOutUI();
        }
      }

      let chartTimeline, chartTypes;
      function initCharts() {
        chartTimeline = new Chart($("chartTimeline").getContext("2d"), {
          type: "line",
          data: { labels: [], datasets: [] },
          options: {
            responsive: true,
            plugins: { legend: { labels: { color: "#d4d4d8" } } },
            scales: {
              x: { ticks: { color: "#a1a1aa" }, grid: { color: "rgba(255,255,255,0.06)" } },
              y: { ticks: { color: "#a1a1aa" }, grid: { color: "rgba(255,255,255,0.06)" } },
            },
          },
        });

        chartTypes = new Chart($("chartTypes").getContext("2d"), {
          type: "doughnut",
          data: { labels: [], datasets: [{ data: [] }] },
          options: { responsive: true, plugins: { legend: { labels: { color: "#d4d4d8" } } } },
        });
      }

      function renderTable(items) {
        const body = $("tableBody");
        body.innerHTML = "";
        if (!items || items.length === 0) {
          body.innerHTML = `<tr><td class="px-3 py-4 text-zinc-500" colspan="5">No blocked threats found.</td></tr>`;
          return;
        }
        for (const it of items) {
          const time = new Date(it.timestamp).toISOString().replace("T", " ").slice(0, 19) + "Z";
          body.insertAdjacentHTML(
            "beforeend",
            `<tr class="text-zinc-200">
              <td class="px-3 py-2 text-xs text-zinc-400 tabular-nums">${time}</td>
              <td class="px-3 py-2 font-medium">${String(it.attack_type || "").toUpperCase()}</td>
              <td class="px-3 py-2 tabular-nums">${Number(it.confidence || 0).toFixed(2)}</td>
              <td class="px-3 py-2">${it.verdict || ""}</td>
              <td class="px-3 py-2 text-xs text-zinc-400">${it.ip_address || "‚Äî"}</td>
            </tr>`
          );
        }
      }

      async function refresh() {
        const [s, t] = await Promise.all([api.stats(), api.threats(120)]);
        const totals = s.totals || {};
        $("totalScans").textContent = String(totals.total_scans ?? 0);
        $("blocked").textContent = String(totals.total_attacks_blocked ?? 0);

        const acc = (s.accuracy || {}).detection_accuracy;
        const fbTotal = (s.accuracy || {}).feedback_total ?? 0;
        if (acc === null || acc === undefined) {
          $("accuracy").textContent = "‚Äî";
          $("accuracyMeta").textContent = fbTotal ? `Feedback total: ${fbTotal}` : "No feedback yet.";
        } else {
          $("accuracy").textContent = `${(Number(acc) * 100).toFixed(1)}%`;
          $("accuracyMeta").textContent = `Feedback total: ${fbTotal}`;
        }

        const tl = s.timeline || [];
        chartTimeline.data.labels = tl.map((x) => x.day);
        chartTimeline.data.datasets = [
          { label: "Scans", data: tl.map((x) => x.scans), borderColor: "rgba(167,139,250,0.85)", backgroundColor: "rgba(167,139,250,0.10)", tension: 0.25, fill: true },
          { label: "Blocked", data: tl.map((x) => x.blocked), borderColor: "rgba(248,113,113,0.85)", backgroundColor: "rgba(248,113,113,0.08)", tension: 0.25, fill: true },
        ];
        chartTimeline.update();

        const byType = (s.breakdown || {}).attacks_by_type || {};
        const labels = ["injection", "jailbreak", "extraction", "manipulation"];
        chartTypes.data.labels = labels;
        chartTypes.data.datasets[0].data = labels.map((k) => Number(byType[k] || 0));
        chartTypes.data.datasets[0].backgroundColor = [
          "rgba(34,211,238,0.35)",
          "rgba(251,191,36,0.35)",
          "rgba(248,113,113,0.35)",
          "rgba(167,139,250,0.35)",
        ];
        chartTypes.update();

        renderTable((t.items || []).slice(0, 120));
      }

      initCharts();
      $("btnRefresh").addEventListener("click", refresh);
      $("profileBtn")?.addEventListener("click", () => $("profileMenu")?.classList.toggle("hidden"));
      document.addEventListener("click", (e) => {
        const wrap = $("userMenuWrap");
        const menu = $("profileMenu");
        if (!wrap || !menu) return;
        if (wrap.contains(e.target)) return;
        menu.classList.add("hidden");
      });
      $("btnLogout")?.addEventListener("click", () => {
        fetch("/api/auth/logout", { method: "POST" }).finally(() => {
          window.location.href = "/login";
        });
      });
      initAuthUI();
      $("footerYear").textContent = String(new Date().getFullYear());
      refresh().catch(() => {});
    </script>
  </body>
</html>

